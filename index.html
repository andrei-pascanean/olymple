<!DOCTYPE html>
<html>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1" />
    <style>
        @keyframes guess-flip {
            0%   { transform: rotateX(90deg); opacity: 0; }
            50%  { opacity: 1; }
            100% { transform: rotateX(0deg); opacity: 1; }
        }
        .guess-cell {
            perspective: 600px;
        }
        .guess-cell .form-control {
            transform: rotateX(90deg);
            opacity: 0;
            font-weight: bold;
        }
        .guess-cell.reveal .form-control {
            animation: guess-flip 0.5s ease-out forwards;
        }
    </style>
</head>

<body>
    <div class="container" id="mainContainer" style="touch-action: manipulation;">
        <div class="modal fade" id="endGameModal" tabindex="-1" aria-labelledby="endGameModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row justify-content-center">
                            <div class="col text-center">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3">
            <div id="liveErrorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-body bg-danger-subtle text-danger-emphasis">
                    Please select a valid country from the list!
                </div>
            </div>
        </div>
        <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3">
            <div id="liveCorrectAnswerToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
                data-bs-autohide="false">
                <div class="toast-body d-flex bg-primary-subtle text-primary-emphasis justify-content-between">
                    <span id="liveCorrectAnswerToastMessage"></span>
                    <button type="button" class="btn-close me-2 m-auto " data-bs-dismiss="toast"
                        aria-label="Close"></button>
                </div>
            </div>
        </div>
        <div class="modal fade" id="howToPlayModal" tabindex="-1" aria-labelledby="howToPlayModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="howToPlayModalLabel">How to Play</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>A new mystery country is revealed every day through its <strong>Olympic medal
                                history</strong>. You get <strong>5 guesses</strong> to figure out which country it
                            is.</p>
                        <p>You'll see the country's <strong>total medal count</strong> and its <strong>top 5 summer and
                                winter sports</strong> with gold, silver, and bronze breakdowns.</p>
                        <hr>
                        <h6>After each guess, you'll see:</h6>
                        <table class="table table-sm mt-2 mb-3">
                            <thead>
                                <tr>
                                    <th class="text-center">Country</th>
                                    <th class="text-center">Distance</th>
                                    <th class="text-center">Direction</th>
                                    <th class="text-center">Accuracy</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center">üáßüá∑ Brazil</td>
                                    <td class="text-center">7,725km</td>
                                    <td class="text-center">‚ÜóÔ∏è</td>
                                    <td class="text-center">61%</td>
                                </tr>
                                <tr>
                                    <td class="text-center">üá™üá∏ Spain</td>
                                    <td class="text-center">1,053km</td>
                                    <td class="text-center">‚ÜóÔ∏è</td>
                                    <td class="text-center">95%</td>
                                </tr>
                                <tr style="background-color: #FFD700;">
                                    <td class="text-center fw-bold">üá´üá∑ France</td>
                                    <td class="text-center fw-bold">0km</td>
                                    <td class="text-center fw-bold">üéâ</td>
                                    <td class="text-center fw-bold">100%</td>
                                </tr>
                            </tbody>
                        </table>
                        <ul class="mb-3">
                            <li><strong>Distance</strong> ‚Äî how far your guess is from the correct country (in km)</li>
                            <li><strong>Direction</strong> ‚Äî an arrow pointing toward the correct country</li>
                            <li><strong>Accuracy</strong> ‚Äî how close you are as a percentage</li>
                        </ul>
                        <hr>
                        <h6>How accuracy works</h6>
                        <p class="mb-1">The maximum possible distance between two points on Earth is ~20,000km. Your
                            accuracy percentage is calculated as:</p>
                        <p class="text-center"><code>accuracy = 100 - (distance / 20,000) √ó 100</code></p>
                        <p class="mb-0">So <strong>1,000km away = 95%</strong>, <strong>10,000km away = 50%</strong>,
                            and <strong>0km = 100%</strong>.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Got it!</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsOffcanvas"
            aria-labelledby="settingsOffcanvasLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="settingsOffcanvasLabel">Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div class="mb-3">
                    <h6>Game Mode</h6>
                    <p class="text-muted small">Filter the daily puzzle to countries with specific medal types.</p>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="summerModeToggle">
                    <label class="form-check-label" for="summerModeToggle">‚òÄÔ∏è Summer Mode</label>
                    <div class="form-text">Only countries with summer medals</div>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="winterModeToggle">
                    <label class="form-check-label" for="winterModeToggle">‚ùÑÔ∏è Winter Mode</label>
                    <div class="form-text">Only countries with winter medals</div>
                </div>
                <hr>
                <p class="text-muted small mb-0">Note: Changing modes will start a new puzzle for today.</p>
            </div>
        </div>
        <div class="row justify-content-center mt-3 mb-3">
            <div class="col-12 col-md-8 col-lg-6 mx-auto text-center">
                <h1 class="d-flex align-items-center justify-content-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                        viewBox="0 0 16 16" style="cursor: pointer; opacity: 0.5;"
                        data-bs-toggle="modal" data-bs-target="#howToPlayModal"
                        onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                        <path
                            d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0" />
                    </svg>
                    <span class="mx-2" id="gameTitle">Daily Olymple</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                        viewBox="0 0 16 16" style="cursor: pointer; opacity: 0.5;"
                        data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas"
                        onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">
                        <path fill-rule="evenodd"
                            d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5" />
                    </svg>
                </h1>
            </div>
        </div>
        <div class="row justify-content-center mt-3 mb-3">
            <div class="col-12 col-md-8 col-lg-8 mx-auto text-center">
                <h3>
                    Guess the country based on its medals!
                </h3>
            </div>
        </div>
        <div class="row justify-content-center mt-3 mb-3">
            <div class="col-12 col-md-8 col-lg-6 mx-auto text-center">
                <h5 id="totalMedalsDisplay">
                </h5>
            </div>
        </div>
        <div class="row justify-content-center mt-3 mb-3" id="summerTableContainer">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th class="text-center" scope="col">‚òÄÔ∏è Top 5 Summer Sports</th>
                            <th class="text-center" scope="col">ü•á Gold</th>
                            <th class="text-center" scope="col">ü•à Silver</th>
                            <th class="text-center" scope="col">ü•â Bronze</th>
                        </tr>
                    </thead>
                    <tbody id="summerTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row justify-content-center" id="winterTableContainer">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th class="text-center" scope="col">‚ùÑÔ∏è Top 5 Winter Sports</th>
                            <th class="text-center" scope="col">ü•á Gold</th>
                            <th class="text-center" scope="col">ü•à Silver</th>
                            <th class="text-center" scope="col">ü•â Bronze</th>
                        </tr>
                    </thead>
                    <tbody id="winterTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row justify-content-center mb-3 mt-3">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <div class="input-group">
                    <input class="form-control" list="datalistCountries" id="searchCountries"
                        placeholder="Type to search a country...">
                    <datalist id="datalistCountries"></datalist>
                    <button class="btn btn-outline-secondary" type="button" id="guess-button">üåç Guess</button>
                </div>
            </div>
        </div>
        <div class="row justify-content-center mb-2">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <div class="row g-1" id="guess_1">
                    <div class="col-12"><input class="form-control text-center" type="text" value="" aria-label=""
                            disabled readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center mb-2">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <div class="row g-1" id="guess_2">
                    <div class="col-12"><input class="form-control text-center" type="text" value="" aria-label=""
                            disabled readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center mb-2">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <div class="row g-1" id="guess_3">
                    <div class="col-12"><input class="form-control text-center" type="text" value="" aria-label=""
                            disabled readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center mb-2">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <div class="row g-1" id="guess_4">
                    <div class="col-12"><input class="form-control text-center" type="text" value="" aria-label=""
                            disabled readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center mb-2">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <div class="row g-1" id="guess_5">
                    <div class="col-12"><input class="form-control text-center" type="text" value="" aria-label=""
                            disabled readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center mb-5">
            <div class="col-12 col-md-8 col-lg-6 mx-auto">
                <div class="row g-1" id="share_button_placeholder">
                </div>
            </div>
        </div>

        <script>
            // Date-based seed: deterministic daily puzzle
            function getDateString() {
                const now = new Date();
                return now.getFullYear() + '-' +
                    String(now.getMonth() + 1).padStart(2, '0') + '-' +
                    String(now.getDate()).padStart(2, '0');
            }

            function hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = ((hash << 5) - hash) + str.charCodeAt(i);
                    hash |= 0;
                }
                return Math.abs(hash);
            }

            function mulberry32(seed) {
                return function() {
                    seed |= 0; seed = seed + 0x6D2B79F5 | 0;
                    let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
                    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
                    return ((t ^ t >>> 14) >>> 0) / 4294967296;
                };
            }

            function seededShuffle(arr, seed) {
                const shuffled = [...arr];
                const rng = mulberry32(seed);
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(rng() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            // Days since launch epoch (game ID computed per mode inside init)
            const EPOCH = new Date('2025-01-01');
            const today = new Date();
            const daysSinceEpoch = Math.floor((today - EPOCH) / (1000 * 60 * 60 * 24));

            function getGameMode() {
                return localStorage.getItem('olympleGameMode') || 'default';
            }

            function setGameMode(mode) {
                localStorage.setItem('olympleGameMode', mode);
            }

            // Name overrides: medal JSON name -> centroid JSON name
            const CENTROID_NAME_MAP = {
                "Ivory Coast": "C√¥te d'Ivoire",
                "North Macedonia": "Macedonia [FYROM]",
                "Curacao": "Netherlands Antilles",
                "US Virgin Islands": "U.S. Virgin Islands"
            };

            // Centroid name -> country-flags.json name (for non-medal countries)
            const CENTROID_TO_FLAG_NAME = {
                "Brunei": "Brunei Darussalam",
                "Congo [DRC]": "Congo, The Democratic Republic of the Congo",
                "Congo [Republic]": "Congo",
                "Falkland Islands [Islas Malvinas]": "Falkland Islands (Malvinas)",
                "Micronesia": "Micronesia, Federated States of Micronesia",
                "North Korea": "Korea, Democratic People's Republic of Korea",
                "South Korea": "Korea, Republic of South Korea",
                "Libya": "Libyan Arab Jamahiriya",
                "Macedonia [FYROM]": "Macedonia",
                "Myanmar [Burma]": "Myanmar",
                "Macau": "Macao",
                "Syria": "Syrian Arab Republic",
                "Tanzania": "Tanzania, United Republic of Tanzania",
                "Vatican City": "Holy See (Vatican City State)",
                "British Virgin Islands": "Virgin Islands, British",
                "U.S. Virgin Islands": "Virgin Islands, U.S.",
                "S√£o Tom√© and Pr√≠ncipe": "Sao Tome and Principe",
                "Palestinian Territories": "Palestinian Territory, Occupied",
                "Saint Helena": "Saint Helena, Ascension and Tristan Da Cunha",
                "R√©union": "Reunion",
                "Pitcairn Islands": "Pitcairn",
                "Cocos [Keeling] Islands": "Cocos (Keeling) Islands",
                "Heard Island and McDonald Islands": "Heard Island and Mcdonald Islands"
            };

            // Centroid names to use as display name overrides (cleaner names for UI)
            const CENTROID_DISPLAY_NAME = {
                "Congo [DRC]": "DR Congo",
                "Congo [Republic]": "Congo",
                "Falkland Islands [Islas Malvinas]": "Falkland Islands",
                "Micronesia": "Micronesia",
                "Macedonia [FYROM]": "North Macedonia",
                "Myanmar [Burma]": "Myanmar",
                "Macau": "Macau",
                "Cocos [Keeling] Islands": "Cocos Islands",
                "S√£o Tom√© and Pr√≠ncipe": "S√£o Tom√© and Pr√≠ncipe",
                "R√©union": "R√©union",
                "Palestinian Territories": "Palestine",
                "U.S. Minor Outlying Islands": "US Outlying Islands"
            };

            function launchConfetti() {
                const canvas = document.createElement('canvas');
                canvas.style.position = 'fixed';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.pointerEvents = 'none';
                canvas.style.zIndex = '9999';
                document.body.appendChild(canvas);

                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'];
                const pieces = [];

                for (let i = 0; i < 200; i++) {
                    pieces.push({
                        x: canvas.width / 2,
                        y: canvas.height / 2,
                        vx: (Math.random() - 0.5) * 20,
                        vy: (Math.random() - 1) * 18,
                        w: Math.random() * 10 + 5,
                        h: Math.random() * 6 + 3,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        rotation: Math.random() * 360,
                        rotationSpeed: (Math.random() - 0.5) * 15,
                        gravity: 0.3 + Math.random() * 0.2,
                        opacity: 1
                    });
                }

                let frame = 0;
                const totalFrames = 180;

                function animate() {
                    frame++;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    pieces.forEach(p => {
                        p.x += p.vx;
                        p.vy += p.gravity;
                        p.y += p.vy;
                        p.vx *= 0.99;
                        p.rotation += p.rotationSpeed;

                        if (frame > totalFrames - 60) {
                            p.opacity = Math.max(0, p.opacity - 0.02);
                        }

                        ctx.save();
                        ctx.translate(p.x, p.y);
                        ctx.rotate(p.rotation * Math.PI / 180);
                        ctx.globalAlpha = p.opacity;
                        ctx.fillStyle = p.color;
                        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                        ctx.restore();
                    });

                    if (frame < totalFrames) {
                        requestAnimationFrame(animate);
                    } else {
                        canvas.remove();
                    }
                }

                animate();
            }

            function renderTable(tbodyId, sports) {
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '';
                sports.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML =
                        `<td class="text-center">${s.emoji} ${s.sport}</td>` +
                        `<td class="text-center">${s.gold}</td>` +
                        `<td class="text-center">${s.silver}</td>` +
                        `<td class="text-center">${s.bronze}</td>`;
                    tbody.appendChild(tr);
                });
            }

            async function init() {
                const [medalData, centroidData, flagsData] = await Promise.all([
                    fetch('olympic-medals.json').then(r => r.json()),
                    fetch('country-centroids.json').then(r => r.json()),
                    fetch('country-flags.json').then(r => r.json())
                ]);

                // Build centroid lookup by name
                const centroidByName = {};
                centroidData.forEach(c => {
                    centroidByName[c.name] = { lat: c.latitude, lon: c.longitude };
                });

                // Build flag lookup by name
                const flagByName = {};
                flagsData.forEach(f => {
                    flagByName[f.name] = f.flag;
                });

                // Build country_data: "üá´üá∑ France" -> { lat, lon, noc }
                const country_data = {};
                const nocs = Object.keys(medalData);

                // 1) Add all medal-winning countries
                nocs.forEach(noc => {
                    const medal = medalData[noc];
                    const displayName = medal.flag + ' ' + medal.name;
                    const centroidName = CENTROID_NAME_MAP[medal.name] || medal.name;
                    const centroid = centroidByName[centroidName];
                    if (centroid) {
                        country_data[displayName] = { lat: centroid.lat, lon: centroid.lon, noc: noc };
                    }
                });

                // Track which centroid names are already covered by medal countries
                const coveredCentroidNames = new Set();
                nocs.forEach(noc => {
                    const medal = medalData[noc];
                    const centroidName = CENTROID_NAME_MAP[medal.name] || medal.name;
                    coveredCentroidNames.add(centroidName);
                });

                // 2) Add all remaining countries from centroids
                centroidData.forEach(c => {
                    if (coveredCentroidNames.has(c.name)) return;

                    const flagName = CENTROID_TO_FLAG_NAME[c.name] || c.name;
                    const flag = flagByName[flagName] || '';
                    if (!flag) return; // skip territories with no flag

                    const displayName = flag + ' ' + (CENTROID_DISPLAY_NAME[c.name] || c.name);
                    country_data[displayName] = { lat: c.latitude, lon: c.longitude, noc: null };
                });

                // Medal countries used for daily puzzle selection
                const gameMode = getGameMode();
                let medalCountries = Object.keys(country_data).filter(k => country_data[k].noc);

                if (gameMode === 'summer') {
                    medalCountries = medalCountries.filter(k => {
                        return medalData[country_data[k].noc].summer.length > 0;
                    });
                } else if (gameMode === 'winter') {
                    medalCountries = medalCountries.filter(k => {
                        return medalData[country_data[k].noc].winter.length > 0;
                    });
                }

                const countries = Object.keys(country_data).sort((a, b) => a.localeCompare(b));

                // Deterministic shuffle: no repeats within a full cycle
                medalCountries.sort();
                const poolSize = medalCountries.length;
                const cycleNumber = Math.floor(daysSinceEpoch / poolSize);
                const dayInCycle = daysSinceEpoch % poolSize;
                const gameId = dayInCycle + 1; // 1-indexed: #1 through #poolSize

                const cycleSeedStr = 'cycle-' + cycleNumber + (gameMode !== 'default' ? '-' + gameMode : '');
                const cycleSeed = hashString(cycleSeedStr);
                const shuffled = seededShuffle(medalCountries, cycleSeed);
                const correct_country = shuffled[dayInCycle];
                const correctNoc = country_data[correct_country].noc;

                // Render medal clue tables
                const correctMedals = medalData[correctNoc];
                document.getElementById('totalMedalsDisplay').textContent = 'Total: üèÖ ' + correctMedals.totalMedals;

                if (correctMedals.summer.length > 0) {
                    renderTable('summerTableBody', correctMedals.summer);
                } else {
                    document.getElementById('summerTableContainer').style.display = 'none';
                }

                if (correctMedals.winter.length > 0) {
                    renderTable('winterTableBody', correctMedals.winter);
                } else {
                    document.getElementById('winterTableContainer').style.display = 'none';
                }

                // Populate datalist
                const input = document.getElementById("searchCountries");
                const datalist = document.getElementById("datalistCountries");
                countries.forEach(country => {
                    const option = document.createElement("option");
                    option.value = country;
                    datalist.appendChild(option);
                });

                const endGameModal = new bootstrap.Modal(document.getElementById("endGameModal"));
                let guesses = 0;
                let performances = [];
                let guessedCountries = new Set();

                // --- Game logic (unchanged) ---

                function haversine(lat1, lon1, lat2, lon2) {
                    const R = 6371;
                    const toRad = deg => deg * Math.PI / 180;
                    const dLat = toRad(lat2 - lat1);
                    const dLon = toRad(lon2 - lon1);
                    const a = Math.sin(dLat / 2) ** 2 +
                        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                        Math.sin(dLon / 2) ** 2;
                    return 2 * R * Math.asin(Math.sqrt(a));
                }

                function getDirection(lat1, lon1, lat2, lon2) {
                    const toRad = deg => deg * Math.PI / 180;
                    const toDeg = rad => rad * 180 / Math.PI;
                    const dLon = toRad(lon2 - lon1);
                    const y = Math.sin(dLon) * Math.cos(toRad(lat2));
                    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                        Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
                    let brng = toDeg(Math.atan2(y, x));
                    brng = (brng + 360) % 360;
                    const dirs = ["‚¨ÜÔ∏è", "‚ÜóÔ∏è", "‚û°Ô∏è", "‚ÜòÔ∏è", "‚¨áÔ∏è", "‚ÜôÔ∏è", "‚¨ÖÔ∏è", "‚ÜñÔ∏è"];
                    return dirs[Math.round(brng / 45) % 8];
                }

                function getProximity(distance) {
                    const maxDist = 20000;
                    let pct = 100 - Math.round((distance / maxDist) * 100);
                    return Math.max(0, Math.min(100, pct));
                }

                function getPerformance(proximity) {
                    const green = 'üü©';
                    const orange = 'üüß';
                    const grey = '‚¨ú';

                    const n_green = Math.floor(proximity / 20)

                    let n_orange = 0
                    let n_grey = 0

                    if (n_green < 5) {
                        if (((proximity / 20) - (Math.floor(proximity / 20))) > 0.5) {
                            n_orange = 1
                        }
                        if ((n_green + n_orange) < 5) {
                            n_grey = 5 - (n_green + n_orange)
                        }
                    }

                    return (green.repeat(n_green) + orange.repeat(n_orange) + grey.repeat(n_grey))
                }

                function shareButtonCopyClipboard(button) {
                    const modeSuffix = gameMode === 'summer' ? ' ‚òÄÔ∏è' : gameMode === 'winter' ? ' ‚ùÑÔ∏è' : '';
                    const clipBoardText = [
                        `#DailyOlymple${modeSuffix} #${gameId} ${guesses}/5`,
                        performances.join("\n"),
                        "https://olymple.vercel.app"
                    ].join("\n");
                    navigator.clipboard.writeText(clipBoardText)
                        .then(() => {
                            button.classList.remove('btn-primary');
                            button.classList.add('btn-success');
                            button.textContent = "Copied to clipboard!";
                        });
                }

                function handleGuess() {

                    if (guesses >= 5) return;

                    const errorToastEl = document.getElementById("liveErrorToast");
                    const errorToastBody = errorToastEl.querySelector(".toast-body");
                    const errorToast = bootstrap.Toast.getOrCreateInstance(errorToastEl);

                    if (!country_data[input.value]) {
                        errorToastBody.textContent = "Please select a valid country from the list!";
                        errorToast.show();
                        return;
                    }

                    if (guessedCountries.has(input.value)) {
                        errorToastBody.textContent = "You already guessed that country!";
                        errorToast.show();
                        return;
                    }

                    guessedCountries.add(input.value);
                    guesses = guesses + 1;

                    const distance = Math.round(haversine(country_data[input.value].lat, country_data[input.value].lon, country_data[correct_country].lat, country_data[correct_country].lon));

                    let heading = getDirection(country_data[input.value].lat, country_data[input.value].lon, country_data[correct_country].lat, country_data[correct_country].lon);

                    const prox = getProximity(distance)

                    const perf = getPerformance(prox)
                    performances.push(perf)

                    if (distance == 0) {
                        heading = 'üéâ'
                    }

                    const guessResultDiv = document.getElementById(`guess_${guesses}`);
                    guessResultDiv.innerHTML = "";

                    const FLIP_DELAY = 350; // ms between each cell
                    const FLIP_DURATION = 500; // ms per flip

                    function createGuessCell(colClass, value) {
                        const col = document.createElement("div");
                        col.classList.add(colClass, "guess-cell");

                        const inp = document.createElement("input");
                        inp.classList.add("form-control", "text-center");
                        inp.type = "text";
                        inp.setAttribute("aria-label", "");
                        inp.setAttribute("value", value);
                        inp.disabled = true;
                        inp.readOnly = true;

                        col.appendChild(inp);
                        return { col, inp };
                    }

                    const countryCell = createGuessCell("col-5", input.value);
                    const distCell = createGuessCell("col-3", distance + "km");
                    const headCell = createGuessCell("col-2", heading);
                    const proxCell = createGuessCell("col-2", prox + "%");

                    const cells = [countryCell, distCell, headCell, proxCell];

                    cells.forEach(c => guessResultDiv.appendChild(c.col));

                    document.getElementById("searchCountries").value = "";

                    // Staggered flip reveal
                    cells.forEach((c, i) => {
                        c.inp.style.animationDelay = (i * FLIP_DELAY) + 'ms';
                        c.col.classList.add('reveal');
                    });

                    const totalAnimTime = (cells.length - 1) * FLIP_DELAY + FLIP_DURATION;

                    if (distance == 0) {
                        setTimeout(() => {
                            cells.forEach(c => {
                                c.inp.style.backgroundColor = '#FFD700';
                                c.inp.style.borderColor = '#FFD700';
                                c.inp.style.color = '#000';
                            });
                            if (guesses === 1) {
                                launchConfetti();
                            }
                        }, totalAnimTime);
                    }

                    if ((guesses == 5) || (distance == 0)) {
                        document.getElementById("guess-button").disabled = true;

                        setTimeout(() => {
                        const correctAnswerToastEl = document.getElementById("liveCorrectAnswerToast");
                        const correctAnswerToastMessage = document.getElementById("liveCorrectAnswerToastMessage");
                        correctAnswerToastMessage.textContent = `The correct answer was: ${correct_country}`;
                        const correctAnswerToast = bootstrap.Toast.getOrCreateInstance(correctAnswerToastEl);
                        correctAnswerToast.show();

                        const heroText = distance == 0 ? "Congratulations!" : "Better luck next time...";

                        const endGameModalBody = document.querySelector("#endGameModal .col");

                        endGameModalBody.innerHTML = '';

                        const resulth1 = document.createElement("h1");
                        resulth1.innerText = heroText
                        endGameModalBody.appendChild(resulth1);

                        const resulth2 = document.createElement("h2");
                        resulth2.innerText = "Daily Olymple"
                        endGameModalBody.appendChild(resulth2);

                        const resultp = document.createElement("p");
                        resultp.innerText = `Puzzle #${gameId}`
                        endGameModalBody.appendChild(resultp);

                        const resultDiv = document.createElement("div");
                        resultDiv.innerHTML = performances.join("<br>");
                        endGameModalBody.appendChild(resultDiv);

                        const shareButton = document.createElement("button");

                        shareButton.type = "button";
                        shareButton.className = "btn btn-primary mt-3 mb-3";
                        shareButton.textContent = "Share";
                        shareButton.id = "shareButton"
                        endGameModalBody.appendChild(shareButton);

                        const share_button_placeholder = document.getElementById("share_button_placeholder");
                        const shareBtnCol = document.createElement("div");
                        shareBtnCol.className = "col-12";

                        const shareBtn = document.createElement("button");
                        shareBtn.type = "button";
                        shareBtn.className = "form-control btn btn-primary text-center";
                        shareBtn.textContent = "Share";
                        shareBtn.id = "globalShareButton";

                        shareBtnCol.appendChild(shareBtn);
                        share_button_placeholder.appendChild(shareBtnCol);

                        endGameModal.show()

                        document.getElementById("shareButton").addEventListener('click', function () {
                            shareButtonCopyClipboard(this)
                        })
                        document.getElementById("globalShareButton").addEventListener('click', function () {
                            shareButtonCopyClipboard(this)
                        })
                        }, totalAnimTime);
                    }
                }

                document.getElementById("guess-button").onclick = handleGuess;

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleGuess();
                    }
                });
            }

            init();

            // --- Settings toggle logic ---
            (function () {
                const summerToggle = document.getElementById('summerModeToggle');
                const winterToggle = document.getElementById('winterModeToggle');
                const currentMode = getGameMode();

                // Set initial toggle state from localStorage
                summerToggle.checked = currentMode === 'summer';
                winterToggle.checked = currentMode === 'winter';

                // Update title with mode indicator
                const titleEl = document.getElementById('gameTitle');
                if (currentMode === 'summer') {
                    titleEl.textContent = 'Daily Olymple ‚òÄÔ∏è';
                } else if (currentMode === 'winter') {
                    titleEl.textContent = 'Daily Olymple ‚ùÑÔ∏è';
                }

                // Mutual exclusion: toggling one off = default, toggling one on = that mode
                summerToggle.addEventListener('change', function () {
                    if (this.checked) {
                        setGameMode('summer');
                    } else {
                        setGameMode('default');
                    }
                    location.reload();
                });

                winterToggle.addEventListener('change', function () {
                    if (this.checked) {
                        setGameMode('winter');
                    } else {
                        setGameMode('default');
                    }
                    location.reload();
                });
            })();
        </script>
</body>

</html>